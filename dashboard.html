<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics | Hadar Sapir</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0e1a' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' fill='%233b82f6' font-size='42' font-weight='700' font-family='Inter,sans-serif'>HS</text></svg>">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <style>
    /* ===== Dashboard Layout ===== */
    .dash-wrap { max-width: var(--max-width); margin: 0 auto; padding: 6rem 2rem 3rem; }
    .dash-header { margin-bottom: 2rem; }
    .dash-header h1 { font-size: 2rem; font-weight: 800; color: var(--color-text); margin-bottom: 0.25rem; }
    .dash-header p { color: var(--color-text-muted); font-size: 0.9rem; }
    .dash-back { color: var(--color-primary); text-decoration: none; font-size: 0.85rem; font-weight: 500; }
    .dash-back:hover { text-decoration: underline; }

    /* ===== KPI Cards ===== */
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
    .kpi-card { background: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 1.25rem 1.5rem; }
    .kpi-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--color-text-muted); font-weight: 600; margin-bottom: 0.4rem; }
    .kpi-value { font-size: 2rem; font-weight: 800; color: var(--color-text); line-height: 1.2; }
    .kpi-value .kpi-unit { font-size: 0.9rem; font-weight: 500; color: var(--color-text-muted); margin-left: 0.15rem; }

    /* ===== Chart Containers ===== */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .chart-card { background: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 1.5rem; }
    .chart-card.full { grid-column: 1 / -1; }
    .chart-title { font-size: 0.95rem; font-weight: 600; color: var(--color-text); margin-bottom: 1rem; }
    .chart-svg { width: 100%; }

    /* ===== Time Toggle ===== */
    .time-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .time-btn { padding: 0.3rem 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: transparent; color: var(--color-text-muted); font-size: 0.75rem; font-weight: 500; font-family: inherit; cursor: pointer; transition: all var(--transition-fast); }
    .time-btn:hover { border-color: var(--color-border-hover); color: var(--color-text-secondary); }
    .time-btn.active { background: rgba(59, 130, 246, 0.15); border-color: var(--color-primary); color: var(--color-primary); }

    /* ===== Referrers / Generic List ===== */
    .ref-list { list-style: none; }
    .ref-item { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0; border-bottom: 1px solid var(--color-border); font-size: 0.85rem; }
    .ref-item:last-child { border-bottom: none; }
    .ref-name { color: var(--color-text-secondary); max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .ref-count { color: var(--color-primary); font-weight: 600; }
    .ref-empty { color: var(--color-text-faint); font-size: 0.85rem; }

    /* ===== D3 Styles ===== */
    .area-fill { fill: rgba(59, 130, 246, 0.15); }
    .area-line { fill: none; stroke: var(--color-primary); stroke-width: 2; }
    .area-dot { fill: var(--color-primary); }
    .bar-rect { fill: var(--color-primary); rx: 4; }
    .bar-label { fill: var(--color-text-secondary); font-size: 12px; }
    .bar-value { fill: var(--color-text-muted); font-size: 11px; }
    .axis text { fill: var(--color-text-faint); font-size: 11px; }
    .axis line, .axis path { stroke: rgba(255,255,255,0.06); }
    .donut-label { fill: var(--color-text-secondary); font-size: 12px; }
    .donut-value { fill: var(--color-text-muted); font-size: 11px; }
    .hist-bar { fill: var(--color-primary); rx: 3; }
    .hist-label { fill: var(--color-text-muted); font-size: 11px; }

    /* ===== Visitor Map ===== */
    #chart-map { position: relative; min-height: 300px; }
    #chart-map svg { display: block; border-radius: 8px; background: #0d1321; }
    .map-land { fill: #1e293b; stroke: rgba(255,255,255,0.15); stroke-width: 0.5; }
    .map-dot { fill: var(--color-primary); opacity: 0.75; stroke: rgba(59,130,246,0.4); stroke-width: 2; cursor: pointer; }
    .map-dot:hover { opacity: 1; stroke-width: 3; }
    .map-tooltip { position: absolute; background: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius-sm); padding: 0.4rem 0.6rem; font-size: 0.75rem; color: var(--color-text-secondary); pointer-events: none; z-index: 10; white-space: nowrap; display: none; }
    .map-controls { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; z-index: 5; }
    .map-btn { width: 28px; height: 28px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-card); color: var(--color-text-muted); font-size: 1rem; font-family: inherit; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; transition: all var(--transition-fast); }
    .map-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }

    /* ===== Visitor Log Table ===== */
    .visitor-log-wrap { max-height: 480px; overflow-y: auto; overflow-x: auto; }
    .visitor-log { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 900px; }
    .visitor-log th { text-align: left; padding: 0.6rem 0.75rem; color: var(--color-text-muted); font-weight: 600; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; border-bottom: 1px solid var(--color-border); position: sticky; top: 0; background: var(--color-card); z-index: 1; }
    .visitor-log td { padding: 0.55rem 0.75rem; border-bottom: 1px solid var(--color-border); color: var(--color-text-secondary); }
    .visitor-log tr:hover td { background: rgba(59, 130, 246, 0.04); }
    .visitor-log .vl-time { color: var(--color-text-muted); white-space: nowrap; }
    .visitor-log .vl-location { color: var(--color-text); font-weight: 500; }
    .visitor-log .vl-org { color: var(--color-text-faint); font-size: 0.75rem; }
    .visitor-log .vl-tag { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 500; background: rgba(59, 130, 246, 0.1); color: var(--color-primary); }
    .visitor-log .vl-tag.returning { background: rgba(34, 211, 238, 0.1); color: var(--color-cyan); }
    .visitor-log .vl-ref { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ===== Password Gate ===== */
    .gate-overlay { position: fixed; inset: 0; z-index: 200; background: var(--color-bg); display: flex; align-items: center; justify-content: center; }
    .gate-box { text-align: center; max-width: 340px; padding: 2rem; }
    .gate-box h2 { font-size: 1.5rem; font-weight: 700; color: var(--color-text); margin-bottom: 0.5rem; }
    .gate-box p { color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 1.5rem; }
    .gate-input { width: 100%; padding: 0.75rem 1rem; background: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text); font-size: 1rem; font-family: inherit; outline: none; transition: border-color var(--transition-fast); }
    .gate-input:focus { border-color: var(--color-primary); }
    .gate-input.error { border-color: #ef4444; animation: shake 0.4s; }
    .gate-submit { margin-top: 0.75rem; width: 100%; padding: 0.75rem; background: var(--color-primary); color: #fff; border: none; border-radius: var(--radius-md); font-size: 0.9rem; font-weight: 500; font-family: inherit; cursor: pointer; transition: background var(--transition-fast); }
    .gate-submit:hover { background: var(--color-primary-hover); }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

    /* ===== Loading ===== */
    .dash-loading { text-align: center; padding: 4rem; color: var(--color-text-muted); font-size: 0.9rem; }

    /* ===== Responsive ===== */
    @media (max-width: 1024px) {
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .kpi-row { grid-template-columns: 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
      .dash-wrap { padding: 5rem 1rem 2rem; }
    }
  </style>
</head>
<body>

<!-- Password Gate -->
<div class="gate-overlay" id="gate">
  <div class="gate-box">
    <h2>Analytics Dashboard</h2>
    <p>Enter the access code to continue.</p>
    <form id="gate-form">
      <input type="password" class="gate-input" id="gate-input" placeholder="Access code" autocomplete="off" autofocus>
      <button type="submit" class="gate-submit">Enter</button>
    </form>
  </div>
</div>

<!-- Dashboard (hidden until auth) -->
<div class="dash-wrap" id="dashboard" style="display:none;">
  <div class="dash-header">
    <a href="index.html" class="dash-back">&larr; Back to site</a>
    <h1>Analytics</h1>
    <p>Visitor data for hadarsapir.com</p>
  </div>

  <!-- KPI Cards — row 1 -->
  <div class="kpi-row">
    <div class="kpi-card"><div class="kpi-label">Total Visits</div><div class="kpi-value" id="kpi-total">—</div></div>
    <div class="kpi-card"><div class="kpi-label">Unique Visitors</div><div class="kpi-value" id="kpi-unique">—</div></div>
    <div class="kpi-card"><div class="kpi-label">Today</div><div class="kpi-value" id="kpi-today">—</div></div>
    <div class="kpi-card"><div class="kpi-label">Returning</div><div class="kpi-value" id="kpi-returning">—</div></div>
  </div>
  <!-- KPI Cards — row 2 -->
  <div class="kpi-row">
    <div class="kpi-card"><div class="kpi-label">Avg Time on Page</div><div class="kpi-value" id="kpi-time">—</div></div>
    <div class="kpi-card"><div class="kpi-label">Top Country</div><div class="kpi-value" id="kpi-country">—</div></div>
    <div class="kpi-card"><div class="kpi-label">Top City</div><div class="kpi-value" id="kpi-city">—</div></div>
    <div class="kpi-card"><div class="kpi-label">Top ISP / Org</div><div class="kpi-value" id="kpi-org" style="font-size:1.1rem;">—</div></div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">

    <!-- Visitor Map -->
    <div class="chart-card full" style="position:relative; overflow:hidden;">
      <div class="chart-title">Visitor Locations</div>
      <div id="chart-map"></div>
      <div class="map-tooltip" id="map-tooltip"></div>
    </div>

    <!-- Visitors Over Time -->
    <div class="chart-card full">
      <div class="chart-title">Visitors Over Time</div>
      <div class="time-toggle" id="time-toggle">
        <button class="time-btn active" data-days="7">7d</button>
        <button class="time-btn" data-days="30">30d</button>
        <button class="time-btn" data-days="90">90d</button>
        <button class="time-btn" data-days="all">All</button>
      </div>
      <div id="chart-timeline"></div>
    </div>

    <!-- Recent Visitors Log -->
    <div class="chart-card full">
      <div class="chart-title">Recent Visitors</div>
      <div class="visitor-log-wrap">
        <table class="visitor-log" id="visitor-log">
          <thead>
            <tr>
              <th>Time</th>
              <th>Location</th>
              <th>ISP / Org</th>
              <th>Device</th>
              <th>Browser</th>
              <th>OS</th>
              <th>Screen</th>
              <th>Language</th>
              <th>Referrer</th>
              <th>Duration</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Visitors by Country</div>
      <div id="chart-countries"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Visitors by City</div>
      <div id="chart-cities"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Top Referrers</div>
      <div id="chart-referrers"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">ISP / Organization</div>
      <div id="chart-orgs"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Device Type</div>
      <div id="chart-devices"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Browser</div>
      <div id="chart-browsers"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Operating System</div>
      <div id="chart-os"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Screen Resolution</div>
      <div id="chart-screens"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Language</div>
      <div id="chart-languages"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Timezone</div>
      <div id="chart-timezones"></div>
    </div>

    <div class="chart-card full">
      <div class="chart-title">Time Spent Distribution</div>
      <div id="chart-timespent"></div>
    </div>
  </div>
</div>

<script>
(function () {
  // ── Config ──
  var SUPABASE_URL = 'https://cbkuupjmemimbfuahizn.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNia3V1cGptZW1pbWJmdWFoaXpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTkyNjEsImV4cCI6MjA4NzUzNTI2MX0.q4BDFj5KN25_FmI2yofH9SBDsFcep9GKZ_VL3UMJLb0';
  var HASH = 'e001dad6f306c7ddb4c0662753355f15214ca8f3cfa19f8c215530c3ac7a3764';
  var COLORS = ['#3b82f6','#22d3ee','#8b5cf6','#f59e0b','#10b981','#ef4444','#ec4899','#6366f1'];

  var allVisits = [];

  // ── Password Gate ──
  async function sha256(text) {
    var buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
    return Array.from(new Uint8Array(buf)).map(function (b) { return b.toString(16).padStart(2, '0'); }).join('');
  }

  if (sessionStorage.getItem('dash_auth') === 'ok') {
    document.getElementById('gate').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadData();
  }

  document.getElementById('gate-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    var input = document.getElementById('gate-input');
    var hash = await sha256(input.value);
    if (hash === HASH) {
      sessionStorage.setItem('dash_auth', 'ok');
      document.getElementById('gate').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadData();
    } else {
      input.classList.add('error');
      setTimeout(function () { input.classList.remove('error'); }, 500);
      input.value = '';
    }
  });

  // ── Load Data ──
  async function loadData() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
      document.getElementById('dashboard').innerHTML = '<div class="dash-loading">Configure SUPABASE_URL and SUPABASE_KEY in dashboard.html and analytics.js to see data.</div>';
      return;
    }
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    var result = await sb.from('visits').select('*').order('visited_at', { ascending: false }).limit(10000);
    if (result.error || !result.data) { document.getElementById('dashboard').innerHTML = '<div class="dash-loading">Error loading data.</div>'; return; }
    allVisits = result.data;
    renderKPIs();
    renderTimeline(7);
    renderVisitorMap();
    renderVisitorLog();
    renderCountries();
    renderBarList('chart-cities', groupBy('city'));
    renderReferrers();
    renderBarList('chart-orgs', groupBy('org'));
    renderDonut('chart-devices', groupBy('device_type'));
    renderDonut('chart-browsers', groupBy('browser'));
    renderDonut('chart-os', groupBy('os'));
    renderBarList('chart-screens', groupBy('screen_resolution'));
    renderBarList('chart-languages', groupBy('language'));
    renderBarList('chart-timezones', groupBy('timezone'));
    renderTimeSpent();
    bindTimeToggle();
  }

  // ── Utilities ──
  function groupBy(key) {
    var map = {};
    allVisits.forEach(function (v) { var k = v[key] || 'Unknown'; map[k] = (map[k] || 0) + 1; });
    return Object.entries(map).sort(function (a, b) { return b[1] - a[1]; });
  }

  function todayStr() { return new Date().toISOString().slice(0, 10); }

  function escHtml(str) {
    var d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }

  function formatTime(iso) {
    if (!iso) return '—';
    var d = new Date(iso);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  }

  function formatDuration(s) {
    if (!s || s <= 0) return '—';
    if (s < 60) return s + 's';
    return Math.floor(s / 60) + 'm ' + (s % 60) + 's';
  }

  // ── KPIs ──
  function renderKPIs() {
    document.getElementById('kpi-total').textContent = allVisits.length.toLocaleString();

    // Unique visitors by ip_hash
    var hashes = {};
    allVisits.forEach(function (v) { if (v.ip_hash) hashes[v.ip_hash] = true; });
    var uniqueCount = Object.keys(hashes).length;
    document.getElementById('kpi-unique').textContent = uniqueCount ? uniqueCount.toLocaleString() : '—';

    // Today
    var today = todayStr();
    var todayCount = allVisits.filter(function (v) { return v.visited_at && v.visited_at.slice(0, 10) === today; }).length;
    document.getElementById('kpi-today').textContent = todayCount.toLocaleString();

    // Returning visitors
    var hashCounts = {};
    allVisits.forEach(function (v) { if (v.ip_hash) hashCounts[v.ip_hash] = (hashCounts[v.ip_hash] || 0) + 1; });
    var returning = Object.values(hashCounts).filter(function (c) { return c > 1; }).length;
    if (uniqueCount > 0) {
      document.getElementById('kpi-returning').innerHTML = returning + '<span class="kpi-unit"> (' + Math.round(returning / uniqueCount * 100) + '%)</span>';
    } else {
      document.getElementById('kpi-returning').textContent = '—';
    }

    // Avg time
    var times = allVisits.map(function (v) { return v.time_spent_s || 0; }).filter(function (t) { return t > 0; });
    if (times.length) {
      var avg = Math.round(times.reduce(function (a, b) { return a + b; }, 0) / times.length);
      document.getElementById('kpi-time').innerHTML = avg + '<span class="kpi-unit">s</span>';
    } else {
      document.getElementById('kpi-time').textContent = '—';
    }

    // Top country, city, org
    var countries = groupBy('country');
    document.getElementById('kpi-country').textContent = countries.length ? countries[0][0] : '—';
    var cities = groupBy('city');
    document.getElementById('kpi-city').textContent = cities.length ? cities[0][0] : '—';
    var orgs = groupBy('org');
    document.getElementById('kpi-org').textContent = orgs.length ? orgs[0][0] : '—';
  }

  // ── Visitor Map (D3 + TopoJSON + Zoom) ──
  function renderVisitorMap() {
    var container = document.getElementById('chart-map');
    container.innerHTML = '';
    var tooltip = document.getElementById('map-tooltip');

    var width = container.clientWidth || container.getBoundingClientRect().width || 800;
    var height = Math.max(Math.min(width * 0.5, 420), 280);

    var svg = d3.select(container).append('svg')
      .attr('width', width).attr('height', height)
      .style('cursor', 'grab');

    var g = svg.append('g');

    var projection = d3.geoNaturalEarth1().scale(width / 5.5).translate([width / 2, height / 2]);
    var path = d3.geoPath().projection(projection);

    // Zoom behavior
    var zoom = d3.zoom().scaleExtent([1, 8]).on('zoom', function (event) {
      g.attr('transform', event.transform);
    });
    svg.call(zoom);

    // Zoom controls
    var controls = document.createElement('div');
    controls.className = 'map-controls';
    controls.innerHTML = '<button class="map-btn" data-zoom="in">+</button><button class="map-btn" data-zoom="out">&minus;</button><button class="map-btn" data-zoom="reset" style="font-size:0.65rem;">R</button>';
    container.appendChild(controls);
    controls.addEventListener('click', function (e) {
      var btn = e.target.closest('.map-btn');
      if (!btn) return;
      var action = btn.dataset.zoom;
      if (action === 'in') svg.transition().duration(300).call(zoom.scaleBy, 1.5);
      else if (action === 'out') svg.transition().duration(300).call(zoom.scaleBy, 0.67);
      else svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
    });

    // Load world map
    d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(function (world) {
      var countries = topojson.feature(world, world.objects.countries);
      g.selectAll('.map-land').data(countries.features).enter().append('path').attr('class', 'map-land').attr('d', path);

      // Plot visitor dots — aggregate by location
      var locMap = {};
      allVisits.forEach(function (v) {
        var lat = parseFloat(v.latitude);
        var lng = parseFloat(v.longitude);
        if (isNaN(lat) || isNaN(lng)) return;
        var key = lat.toFixed(2) + ',' + lng.toFixed(2);
        if (!locMap[key]) locMap[key] = { lat: lat, lng: lng, city: v.city || '', country: v.country || '', count: 0 };
        locMap[key].count++;
      });
      var locations = Object.values(locMap);
      console.log('[Map] Visits with coords:', allVisits.filter(function(v){ return v.latitude && v.longitude; }).length, '| Unique locations:', locations.length);

      if (locations.length) {
        var maxCount = d3.max(locations, function (d) { return d.count; }) || 1;
        var rScale = d3.scaleSqrt().domain([1, Math.max(maxCount, 2)]).range([3, 10]);

        g.selectAll('.map-dot').data(locations).enter().append('circle')
          .attr('class', 'map-dot')
          .attr('cx', function (d) { return projection([d.lng, d.lat])[0]; })
          .attr('cy', function (d) { return projection([d.lng, d.lat])[1]; })
          .attr('r', function (d) { return rScale(d.count); })
          .on('mouseenter', function (event, d) {
            tooltip.style.display = 'block';
            tooltip.textContent = d.city + (d.city && d.country ? ', ' : '') + d.country + ' — ' + d.count + ' visit' + (d.count > 1 ? 's' : '');
          })
          .on('mousemove', function (event) {
            tooltip.style.left = (event.offsetX + 12) + 'px';
            tooltip.style.top = (event.offsetY - 10) + 'px';
          })
          .on('mouseleave', function () { tooltip.style.display = 'none'; });
      }
    }).catch(function (err) {
      console.error('Map load error:', err);
      container.innerHTML = '<p class="ref-empty">Could not load map data. Check console for details.</p>';
    });
  }

  // ── Visitor Log ──
  function renderVisitorLog() {
    var tbody = document.querySelector('#visitor-log tbody');
    tbody.innerHTML = '';

    // Count visits per ip_hash for returning detection
    var hashCounts = {};
    allVisits.forEach(function (v) { if (v.ip_hash) hashCounts[v.ip_hash] = (hashCounts[v.ip_hash] || 0) + 1; });

    // Show most recent 100
    var recent = allVisits.slice(0, 100);
    recent.forEach(function (v) {
      var location = [v.city, v.region, v.country].filter(Boolean).join(', ');
      var ref = '';
      if (v.referrer) {
        try { ref = new URL(v.referrer).hostname.replace('www.', ''); } catch (_) { ref = v.referrer; }
      }
      var isReturning = v.ip_hash && hashCounts[v.ip_hash] > 1;

      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td class="vl-time">' + escHtml(formatTime(v.visited_at)) + '</td>' +
        '<td class="vl-location">' + escHtml(location || 'Unknown') + '</td>' +
        '<td class="vl-org">' + escHtml(v.org || '—') + '</td>' +
        '<td>' + escHtml(v.device_type || '—') + '</td>' +
        '<td>' + escHtml(v.browser || '—') + '</td>' +
        '<td>' + escHtml(v.os || '—') + '</td>' +
        '<td>' + escHtml(v.screen_resolution || '—') + '</td>' +
        '<td>' + escHtml(v.language || '—') + '</td>' +
        '<td class="vl-ref" title="' + escHtml(v.referrer || '') + '">' + escHtml(ref || 'Direct') + '</td>' +
        '<td>' + formatDuration(v.time_spent_s) + '</td>' +
        '<td>' + (isReturning ? '<span class="vl-tag returning">Returning</span>' : '<span class="vl-tag">New</span>') + '</td>';
      tbody.appendChild(tr);
    });
  }

  // ── Timeline (Area Chart) ──
  function renderTimeline(days) {
    var container = document.getElementById('chart-timeline');
    container.innerHTML = '';
    var now = new Date();
    var cutoff = days === 'all' ? null : new Date(now.getTime() - days * 86400000);
    var filtered = cutoff ? allVisits.filter(function (v) { return new Date(v.visited_at) >= cutoff; }) : allVisits;

    var byDate = {};
    filtered.forEach(function (v) {
      var d = v.visited_at.slice(0, 10);
      byDate[d] = (byDate[d] || 0) + 1;
    });

    var dates = Object.keys(byDate).sort();
    if (!dates.length) { container.innerHTML = '<p class="ref-empty">No data for this period.</p>'; return; }
    var start = new Date(dates[0]), end = new Date(dates[dates.length - 1]);
    var series = [];
    for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      var key = d.toISOString().slice(0, 10);
      series.push({ date: new Date(key), count: byDate[key] || 0 });
    }

    var margin = { top: 10, right: 20, bottom: 30, left: 40 };
    var width = container.clientWidth - margin.left - margin.right;
    var height = 200;

    var svg = d3.select(container).append('svg').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom).append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var x = d3.scaleTime().domain(d3.extent(series, function (d) { return d.date; })).range([0, width]);
    var y = d3.scaleLinear().domain([0, d3.max(series, function (d) { return d.count; }) || 1]).nice().range([height, 0]);

    svg.append('g').attr('class', 'axis').attr('transform', 'translate(0,' + height + ')').call(d3.axisBottom(x).ticks(Math.min(series.length, 8)).tickFormat(d3.timeFormat('%b %d'))).select('.domain').remove();
    svg.append('g').attr('class', 'axis').call(d3.axisLeft(y).ticks(5).tickSize(-width)).select('.domain').remove();
    svg.selectAll('.axis .tick line').attr('stroke', 'rgba(255,255,255,0.04)');

    var area = d3.area().x(function (d) { return x(d.date); }).y0(height).y1(function (d) { return y(d.count); }).curve(d3.curveMonotoneX);
    var line = d3.line().x(function (d) { return x(d.date); }).y(function (d) { return y(d.count); }).curve(d3.curveMonotoneX);

    svg.append('path').datum(series).attr('class', 'area-fill').attr('d', area);
    svg.append('path').datum(series).attr('class', 'area-line').attr('d', line);

    if (series.length <= 60) {
      svg.selectAll('.area-dot').data(series).enter().append('circle').attr('class', 'area-dot').attr('cx', function (d) { return x(d.date); }).attr('cy', function (d) { return y(d.count); }).attr('r', 3);
    }
  }

  function bindTimeToggle() {
    document.getElementById('time-toggle').addEventListener('click', function (e) {
      if (!e.target.classList.contains('time-btn')) return;
      document.querySelectorAll('.time-btn').forEach(function (b) { b.classList.remove('active'); });
      e.target.classList.add('active');
      var days = e.target.dataset.days;
      renderTimeline(days === 'all' ? 'all' : parseInt(days));
    });
  }

  // ── Countries (Horizontal Bar) ──
  function renderCountries() {
    renderHBar('chart-countries', groupBy('country').slice(0, 10));
  }

  function renderHBar(containerId, data) {
    var container = document.getElementById(containerId);
    container.innerHTML = '';
    if (!data.length) { container.innerHTML = '<p class="ref-empty">No data yet.</p>'; return; }

    var margin = { top: 5, right: 40, bottom: 5, left: 100 };
    var barH = 28, gap = 4;
    var width = container.clientWidth - margin.left - margin.right;
    var height = data.length * (barH + gap);

    var svg = d3.select(container).append('svg').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom).append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var x = d3.scaleLinear().domain([0, d3.max(data, function (d) { return d[1]; })]).range([0, width]);
    var y = d3.scaleBand().domain(data.map(function (d) { return d[0]; })).range([0, height]).padding(0.15);

    svg.selectAll('.bar-rect').data(data).enter().append('rect').attr('class', 'bar-rect').attr('x', 0).attr('y', function (d) { return y(d[0]); }).attr('width', function (d) { return x(d[1]); }).attr('height', y.bandwidth());

    svg.selectAll('.bar-label').data(data).enter().append('text').attr('class', 'bar-label').attr('x', -8).attr('y', function (d) { return y(d[0]) + y.bandwidth() / 2; }).attr('dy', '0.35em').attr('text-anchor', 'end').text(function (d) { return d[0]; });

    svg.selectAll('.bar-value').data(data).enter().append('text').attr('class', 'bar-value').attr('x', function (d) { return x(d[1]) + 6; }).attr('y', function (d) { return y(d[0]) + y.bandwidth() / 2; }).attr('dy', '0.35em').text(function (d) { return d[1]; });
  }

  // ── Bar List (simple ranked list for smaller datasets) ──
  function renderBarList(containerId, data) {
    var container = document.getElementById(containerId);
    container.innerHTML = '';
    var top = data.slice(0, 10);
    if (!top.length) { container.innerHTML = '<p class="ref-empty">No data yet.</p>'; return; }

    var ul = document.createElement('ul');
    ul.className = 'ref-list';
    top.forEach(function (r) {
      var li = document.createElement('li');
      li.className = 'ref-item';
      li.innerHTML = '<span class="ref-name">' + escHtml(r[0]) + '</span><span class="ref-count">' + r[1] + '</span>';
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }

  // ── Donut Chart ──
  function renderDonut(containerId, data) {
    var container = document.getElementById(containerId);
    container.innerHTML = '';
    if (!data.length) { container.innerHTML = '<p class="ref-empty">No data yet.</p>'; return; }

    var size = Math.min(container.clientWidth, 260);
    var radius = size / 2;
    var inner = radius * 0.55;
    var total = data.reduce(function (a, d) { return a + d[1]; }, 0);

    var svg = d3.select(container).append('svg').attr('width', size).attr('height', size + data.length * 20 + 10).append('g').attr('transform', 'translate(' + radius + ',' + radius + ')');

    var pie = d3.pie().value(function (d) { return d[1]; }).sort(null);
    var arc = d3.arc().innerRadius(inner).outerRadius(radius - 4);

    svg.selectAll('path').data(pie(data)).enter().append('path').attr('d', arc).attr('fill', function (d, i) { return COLORS[i % COLORS.length]; }).attr('stroke', '#111827').attr('stroke-width', 2);

    svg.append('text').attr('text-anchor', 'middle').attr('dy', '-0.1em').attr('fill', '#fff').attr('font-size', '1.5rem').attr('font-weight', '700').text(total);
    svg.append('text').attr('text-anchor', 'middle').attr('dy', '1.2em').attr('fill', '#9ca3af').attr('font-size', '0.7rem').text('total');

    var legend = d3.select(container).select('svg').append('g').attr('transform', 'translate(10,' + (size + 10) + ')');
    data.forEach(function (d, i) {
      var g = legend.append('g').attr('transform', 'translate(0,' + (i * 20) + ')');
      g.append('rect').attr('width', 12).attr('height', 12).attr('rx', 3).attr('fill', COLORS[i % COLORS.length]);
      g.append('text').attr('class', 'donut-label').attr('x', 18).attr('y', 10).text(d[0]);
      g.append('text').attr('class', 'donut-value').attr('x', size - 30).attr('y', 10).attr('text-anchor', 'end').text(d[1] + ' (' + Math.round(d[1] / total * 100) + '%)');
    });
  }

  // ── Referrers ──
  function renderReferrers() {
    var container = document.getElementById('chart-referrers');
    container.innerHTML = '';
    var refs = {};
    allVisits.forEach(function (v) {
      if (!v.referrer) return;
      var host;
      try { host = new URL(v.referrer).hostname.replace('www.', ''); } catch (_) { host = v.referrer; }
      if (host) refs[host] = (refs[host] || 0) + 1;
    });
    var sorted = Object.entries(refs).sort(function (a, b) { return b[1] - a[1]; }).slice(0, 10);
    if (!sorted.length) { container.innerHTML = '<p class="ref-empty">No referrer data yet.</p>'; return; }

    var ul = document.createElement('ul');
    ul.className = 'ref-list';
    sorted.forEach(function (r) {
      var li = document.createElement('li');
      li.className = 'ref-item';
      li.innerHTML = '<span class="ref-name">' + escHtml(r[0]) + '</span><span class="ref-count">' + r[1] + '</span>';
      ul.appendChild(li);
    });
    container.appendChild(ul);
  }

  // ── Time Spent Distribution ──
  function renderTimeSpent() {
    var container = document.getElementById('chart-timespent');
    container.innerHTML = '';
    var buckets = [
      { label: '0-10s', min: 0, max: 10, count: 0 },
      { label: '10-30s', min: 10, max: 30, count: 0 },
      { label: '30-60s', min: 30, max: 60, count: 0 },
      { label: '1-3m', min: 60, max: 180, count: 0 },
      { label: '3-5m', min: 180, max: 300, count: 0 },
      { label: '5m+', min: 300, max: Infinity, count: 0 }
    ];
    allVisits.forEach(function (v) {
      var t = v.time_spent_s || 0;
      for (var i = 0; i < buckets.length; i++) {
        if (t >= buckets[i].min && t < buckets[i].max) { buckets[i].count++; break; }
      }
    });

    var margin = { top: 10, right: 20, bottom: 30, left: 40 };
    var width = container.clientWidth - margin.left - margin.right;
    var height = 180;

    var svg = d3.select(container).append('svg').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom).append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var x = d3.scaleBand().domain(buckets.map(function (b) { return b.label; })).range([0, width]).padding(0.2);
    var y = d3.scaleLinear().domain([0, d3.max(buckets, function (b) { return b.count; }) || 1]).nice().range([height, 0]);

    svg.append('g').attr('class', 'axis').attr('transform', 'translate(0,' + height + ')').call(d3.axisBottom(x)).select('.domain').remove();
    svg.append('g').attr('class', 'axis').call(d3.axisLeft(y).ticks(5).tickSize(-width)).select('.domain').remove();
    svg.selectAll('.axis .tick line').attr('stroke', 'rgba(255,255,255,0.04)');

    svg.selectAll('.hist-bar').data(buckets).enter().append('rect').attr('class', 'hist-bar').attr('x', function (d) { return x(d.label); }).attr('y', function (d) { return y(d.count); }).attr('width', x.bandwidth()).attr('height', function (d) { return height - y(d.count); });

    svg.selectAll('.hist-label').data(buckets).enter().append('text').attr('class', 'hist-label').attr('x', function (d) { return x(d.label) + x.bandwidth() / 2; }).attr('y', function (d) { return y(d.count) - 6; }).attr('text-anchor', 'middle').text(function (d) { return d.count || ''; });
  }
})();
</script>
</body>
</html>
